<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการประชุม อสม.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Modern Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.8), 0 0 40px rgba(34, 197, 94, 0.4); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* Custom Classes */
        .fade-in-up { animation: fadeInUp 0.6s ease-out; }
        .fade-in-left { animation: fadeInLeft 0.6s ease-out; }
        .fade-in-scale { animation: fadeInScale 0.5s ease-out; }
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .gradient-button:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
        }
        
        .gradient-button:active {
            transform: translateY(0px);
        }
        
        .action-button {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-button:hover {
            transform: scale(1.1);
        }
        
        .action-button:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.1;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .action-button:hover:before {
            width: 50px;
            height: 50px;
        }
        
        .shimmer-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 2s infinite;
        }
        
        .attendee-checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid rgba(99, 102, 241, 0.1);
            border-radius: 16px;
            background: rgba(249, 250, 251, 0.8);
            backdrop-filter: blur(10px);
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
        }
        
        .attendee-checkbox-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .attendee-checkbox-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .attendee-checkbox-list::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }
        
        .table-row {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .table-row:hover {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.05) 0%, rgba(255, 255, 255, 0.8) 100%);
            border-left-color: #6366f1;
            transform: translateX(5px);
        }
        
        .search-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(99, 102, 241, 0.1);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .vhv-option {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 0;
        }
        
        .vhv-option:hover {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 254, 255, 0.8) 100%);
            transform: translateX(5px);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.8) 100%);
        }
        
        /* Loading animation */
        .loading-pulse {
            animation: float 2s ease-in-out infinite;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .attendee-checkbox-list {
                max-height: 200px;
            }
        }

        .swal2-container { z-index: 9999; }
        
        /* Custom SweetAlert2 styling */
        .swal2-popup {
            border-radius: 20px !important;
            border: none !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2) !important;
        }
        
        .swal2-confirm {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }
        
        .swal2-confirm:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4) !important;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="main-view" class="min-h-screen">
        <!-- Modern Navigation -->
        <nav class="glass-nav text-white p-4 shadow-2xl sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4 fade-in-left">
                    <div class="relative">
                        <img src="osm.png" alt="Logo" class="h-16 w-16 object-contain loading-pulse">
                        <div class="absolute inset-0 bg-white bg-opacity-20 rounded-full animate-ping"></div>
                    </div>
                    <div>
                        <h1 id="facility-name-header" class="text-xl font-bold bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent"></h1>
                        <div class="text-sm text-white text-opacity-80">ระบบจัดการการประชุม</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-6 fade-in-up">
                    <div class="text-right hidden md:block">
                        <div id="user-name" class="font-semibold text-white"></div>
                        <div id="user-position" class="text-sm text-white text-opacity-70"></div>
                    </div>
                    <a href="index.html" class="flex items-center gap-2 bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-filter backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0L3.586 10l4.707-4.707a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        กลับหน้าหลัก
                    </a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Header Card with Statistics -->
            <div class="glass-card p-8 rounded-3xl shadow-2xl mb-8 fade-in-scale hover-lift">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">ประวัติการประชุม</h2>
                                <p class="text-gray-600 mt-1">จัดการข้อมูลการประชุม อสม. อย่างมีประสิทธิภาพ</p>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                            <div class="stats-card p-4 rounded-2xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div id="total-meetings" class="text-xl font-bold text-gray-800">-</div>
                                        <div class="text-sm text-gray-600">การประชุมทั้งหมด</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stats-card p-4 rounded-2xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div id="total-participants" class="text-xl font-bold text-gray-800">-</div>
                                        <div class="text-sm text-gray-600">ผู้เข้าร่วมเฉลี่ย</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stats-card p-4 rounded-2xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div id="this-month" class="text-xl font-bold text-gray-800">-</div>
                                        <div class="text-sm text-gray-600">เดือนนี้</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="showAddMeetingModal()" class="gradient-button text-white font-semibold py-4 px-8 rounded-2xl shadow-xl hover-lift flex items-center gap-3 text-lg">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <span class="hidden sm:inline">เพิ่มบันทึกการประชุม</span>
                        <span class="sm:hidden">เพิ่มการประชุม</span>
                    </button>
                </div>
            </div>

            <!-- Modern Table -->
            <div class="glass-card shadow-2xl rounded-3xl overflow-hidden fade-in-up hover-lift">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="text-sm font-semibold text-gray-800 bg-gradient-to-r from-gray-50 to-blue-50">
                            <tr>
                                <th scope="col" class="px-8 py-6">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        วันที่ประชุม
                                    </div>
                                </th>
                                <th scope="col" class="px-8 py-6">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        หัวข้อการประชุม
                                    </div>
                                </th>
                                <th scope="col" class="px-8 py-6">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                        ผู้เข้าร่วม
                                    </div>
                                </th>
                                <th scope="col" class="px-8 py-6 text-center">
                                    <div class="flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                                        </svg>
                                        จัดการ
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="meetings-table-body" class="divide-y divide-gray-100">
                            <!-- Meeting rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuMilkxeAl3AcRXdcOr4VZvlB6z5tuqKGePrD8qqmMdfNjHuk1-cT8Pq7caw8SNFTQ/exec';
        const meetingsTableBody = document.getElementById('meetings-table-body');
        
        let appState = {
            user: null,
            meetings: [],
            vhvList: []
        };

        // --- Initialization and Auth ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = sessionStorage.getItem('vhvUser');
            if (storedUser) {
                appState.user = JSON.parse(storedUser);
                document.getElementById('facility-name-header').textContent = `บันทึกประชุม - ${appState.user.facilityName}`;
                document.getElementById('user-name').textContent = appState.user.fullName;
                document.getElementById('user-position').textContent = appState.user.position;
                fetchInitialData();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Add this debug function to your HTML file
        async function debugMeetingsData() {
            console.log('=== DEBUG: Frontend debugging ===');
            console.log('User data:', appState.user);
            console.log('APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
            
            const url = `${APPS_SCRIPT_URL}?action=getMeetings&facilityId=${appState.user.facilityId}`;
            console.log('Request URL:', url);
            
            try {
                const response = await fetch(url);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                
                try {
                    const jsonData = JSON.parse(responseText);
                    console.log('Parsed JSON data:', jsonData);
                    
                    if (jsonData.debug) {
                        console.log('Debug info from backend:', jsonData.debug);
                    }
                } catch (parseError) {
                    console.log('JSON parse error:', parseError);
                    console.log('Response might not be valid JSON');
                }
                
            } catch (fetchError) {
                console.log('Fetch error:', fetchError);
            }
        }

        // Updated fetchInitialData with better debugging
        async function fetchInitialData() {
            showLoadingSpinner();
            console.log('=== Starting fetchInitialData ===');
            
            try {
                // Fetch VHV list first
                console.log('Fetching VHV list...');
                const vhvResponse = await fetch(`${APPS_SCRIPT_URL}?action=getVhvList&facilityId=${appState.user.facilityId}`);
                
                if (!vhvResponse.ok) {
                    throw new Error(`VHV HTTP error! status: ${vhvResponse.status}`);
                }
                
                const vhvList = await vhvResponse.json();
                console.log('VHV list received:', Array.isArray(vhvList) ? vhvList.length : 'Not an array');
                
                // Process VHV list
                if (Array.isArray(vhvList)) {
                    // Sort by moo (หมู่) then by fullName
                    appState.vhvList = vhvList.sort((a, b) => {
                        const mooA = parseInt(a.data.moo || '0', 10);
                        const mooB = parseInt(b.data.moo || '0', 10);
                        if (mooA !== mooB) return mooA - mooB;
                        return (a.data.fullName || '').localeCompare(b.data.fullName || '', 'th');
                    });
                } else {
                    console.warn('VHV list is not an array:', vhvList);
                    appState.vhvList = [];
                }
                
                // Fetch meetings
                console.log('Fetching meetings...');
                const meetingsResponse = await fetch(`${APPS_SCRIPT_URL}?action=getMeetings&facilityId=${appState.user.facilityId}`);
                
                if (!meetingsResponse.ok) {
                    throw new Error(`Meetings HTTP error! status: ${meetingsResponse.status}`);
                }
                
                const meetingsText = await meetingsResponse.text();
                console.log('Raw meetings response length:', meetingsText.length);
                console.log('First 500 chars:', meetingsText.substring(0, 500));
                
                let meetingsData;
                try {
                    meetingsData = JSON.parse(meetingsText);
                } catch (parseError) {
                    console.error('Failed to parse meetings response:', parseError);
                    throw new Error('Invalid response format from server');
                }
                
                console.log('Meetings data parsed:', meetingsData);
                console.log('Is meetings data an array?', Array.isArray(meetingsData));
                console.log('Does meetings data have status?', meetingsData.hasOwnProperty('status'));

                // Process meetings data - check if it's the correct format
                if (meetingsData && meetingsData.status === 'success') {
                    // Correct format: {status: 'success', data: [...]}
                    appState.meetings = Array.isArray(meetingsData.data) ? meetingsData.data : [];
                    console.log('Meetings loaded successfully:', appState.meetings.length);
                    renderMeetingsTable();
                    updateStatistics(); // Update stats after loading data
                } else if (Array.isArray(meetingsData)) {
                    // Wrong format: got VHV data instead of meeting data
                    console.error('Received VHV data instead of meeting data');
                    throw new Error('เซิร์ฟเวอร์ส่งข้อมูล VHV กลับมาแทนข้อมูลการประชุม กรุณาตรวจสอบ Google Apps Script');
                } else if (meetingsData && meetingsData.status === 'error') {
                    // Error response
                    throw new Error(meetingsData.message || 'Unknown server error');
                } else {
                    // Unknown format
                    console.error('Unknown response format:', meetingsData);
                    throw new Error('รูปแบบข้อมูลจากเซิร์ฟเวอร์ไม่ถูกต้อง');
                }

            } catch (error) {
                console.error('=== fetchInitialData ERROR ===');
                console.error('Error details:', error);
                
                // Show detailed error message
                let errorMessage = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
                let debugInfo = error.message;
                
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้';
                } else if (error.message.includes('Invalid response format')) {
                    errorMessage = 'เซิร์ฟเวอร์ส่งข้อมูลในรูปแบบที่ไม่ถูกต้อง';
                } else if (error.message.includes('VHV กลับมาแทน')) {
                    errorMessage = 'เซิร์ฟเวอร์ส่งข้อมูลผิดประเภท';
                    debugInfo = 'Google Apps Script ไม่มี case สำหรับ getMeetings ใน doGet function';
                }
                
                meetingsTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center p-12">
                            <div class="glass-card rounded-2xl p-8 max-w-md mx-auto">
                                <div class="text-red-500 mb-6">
                                    <div class="w-20 h-20 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <p class="text-xl font-bold text-gray-800 mb-2">${errorMessage}</p>
                                    <p class="text-sm text-gray-600 mb-2">รายละเอียด: ${debugInfo}</p>
                                    <p class="text-xs text-gray-400">ดู Console สำหรับรายละเอียดเพิ่มเติม</p>
                                </div>
                                <div class="space-x-3">
                                    <button onclick="fetchInitialData()" class="gradient-button text-white px-6 py-3 rounded-xl font-semibold hover-lift">
                                        ลองใหม่อีกครั้ง
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Initialize empty state
                appState.vhvList = [];
                appState.meetings = [];
                updateStatistics(); // Update stats even on error
            }
        }

        function showLoadingSpinner() {
            meetingsTableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center p-12">
                        <div class="flex flex-col justify-center items-center gap-4 text-gray-500">
                            <div class="relative">
                                <div class="w-16 h-16 border-4 border-blue-200 rounded-full animate-spin border-t-blue-600"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <img src="osm.png" alt="Loading..." class="w-8 h-8 loading-pulse">
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-700">กำลังโหลดข้อมูล</div>
                                <div class="text-sm text-gray-500">กรุณารอสักครู่...</div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // --- Statistics Update Function ---
        function updateStatistics() {
            const totalMeetings = appState.meetings.length;
            const totalParticipants = totalMeetings > 0 
                ? Math.round(appState.meetings.reduce((sum, meeting) => sum + (meeting.attendees?.length || 0), 0) / totalMeetings)
                : 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthMeetings = appState.meetings.filter(meeting => {
                const meetingDate = new Date(meeting.date);
                return meetingDate.getMonth() === currentMonth && meetingDate.getFullYear() === currentYear;
            }).length;
            
            // Animate numbers
            animateNumber('total-meetings', totalMeetings);
            animateNumber('total-participants', totalParticipants);
            animateNumber('this-month', thisMonthMeetings);
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const duration = 1000;
            const start = 0;
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.round(start + (targetNumber - start) * easeOutQuart(progress));
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        function easeOutQuart(t) {
            return 1 - Math.pow(1 - t, 4);
        }

        // --- Render Functions ---
        function renderMeetingsTable() {
            meetingsTableBody.innerHTML = '';
            if (appState.meetings.length === 0) {
                meetingsTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center p-12">
                            <div class="glass-card rounded-2xl p-8 max-w-md mx-auto">
                                <div class="w-20 h-20 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">ยังไม่มีข้อมูลการประชุม</h3>
                                <p class="text-gray-600 mb-6">เริ่มต้นสร้างบันทึกการประชุมแรกของคุณ</p>
                                <button onclick="showAddMeetingModal()" class="gradient-button text-white px-6 py-3 rounded-xl font-semibold hover-lift">
                                    เพิ่มการประชุมแรก
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort meetings by date, newest first
            appState.meetings.sort((a, b) => new Date(b.date) - new Date(a.date));

            appState.meetings.forEach((meeting, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.style.animationDelay = `${index * 0.1}s`;
                
                const meetingDate = new Date(meeting.date);
                const formattedDate = meetingDate.toLocaleDateString('th-TH', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });

                const attendeeCount = meeting.attendees ? meeting.attendees.length : 0;

                row.innerHTML = `
                    <td class="px-8 py-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${formattedDate}</div>
                                <div class="text-sm text-gray-500">${formatDateRelative(meetingDate)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-6">
                        <div class="font-medium text-gray-900 mb-1">${meeting.topic || '-'}</div>
                        <div class="text-sm text-gray-500 max-w-xs truncate">${meeting.summary || 'ไม่มีสรุป'}</div>
                    </td>
                    <td class="px-8 py-6">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <span class="font-semibold text-gray-800">${attendeeCount}</span>
                            <span class="text-gray-500 text-sm">คน</span>
                        </div>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick='showViewMeetingModal("${meeting.id}")' class="action-button p-3 rounded-full text-blue-600 hover:bg-blue-100" title="ดูรายละเอียด">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick='showEditMeetingModal("${meeting.id}")' class="action-button p-3 rounded-full text-amber-600 hover:bg-amber-100" title="แก้ไข">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick='confirmDeleteMeeting("${meeting.id}")' class="action-button p-3 rounded-full text-red-600 hover:bg-red-100" title="ลบ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                
                row.classList.add('fade-in-up');
                meetingsTableBody.appendChild(row);
            });
        }

        function formatDateRelative(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'วันนี้';
            if (diffDays === 1) return 'เมื่อวาน';
            if (diffDays <= 7) return `${diffDays} วันที่แล้ว`;
            if (diffDays <= 30) return `${Math.ceil(diffDays / 7)} สัปดาห์ที่แล้ว`;
            return `${Math.ceil(diffDays / 30)} เดือนที่แล้ว`;
        }

        // --- Modal and Form Logic ---
        function getMeetingFormHTML(meeting = {}) {
            const vhvOptions = appState.vhvList.map(vhv => {
                const isChecked = meeting.attendees && meeting.attendees.some(att => att.idCard === vhv.data.idCard);
                return `
                    <label class="vhv-option flex items-center space-x-3 p-3 rounded-xl hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer" data-fullname="${vhv.data.fullName}" data-moo="${vhv.data.moo}">
                        <input type="checkbox" name="attendees" value="${vhv.data.idCard}" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" ${isChecked ? 'checked' : ''}>
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                ${vhv.data.fullName.charAt(0)}
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${vhv.data.fullName}</div>
                                <div class="text-sm text-gray-500">หมู่ ${vhv.data.moo}</div>
                            </div>
                        </div>
                    </label>
                `;
            }).join('');

            return `
                <div class="space-y-6 text-left max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                วันที่ประชุม
                            </label>
                            <input id="meetingDate" type="date" class="mt-1 block w-full rounded-xl border-2 border-gray-200 px-4 py-3 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="${meeting.date ? new Date(meeting.date).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                หัวข้อการประชุม
                            </label>
                            <input id="meetingTopic" type="text" class="mt-1 block w-full rounded-xl border-2 border-gray-200 px-4 py-3 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="เช่น การเฝ้าระวังโรคไข้เลือดออก" value="${meeting.topic || ''}">
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            สรุปเนื้อหา
                        </label>
                        <textarea id="meetingSummary" rows="4" class="mt-1 block w-full rounded-xl border-2 border-gray-200 px-4 py-3 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="สรุปสาระสำคัญของการประชุม...">${meeting.summary || ''}</textarea>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            รายชื่อผู้เข้าร่วมประชุม
                        </label>
                        
                        <div class="search-input rounded-xl px-4 py-3 border-2">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input id="vhvSearchInput" type="text" placeholder="ค้นหาชื่อหรือหมู่..." class="flex-1 border-none outline-none bg-transparent text-gray-700 placeholder-gray-400" oninput="filterVhvOptions()">
                            </div>
                        </div>
                        
                        <div class="attendee-checkbox-list p-4 space-y-2" id="vhvOptionsList">
                            ${vhvOptions}
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 text-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm font-medium">ผู้เข้าร่วมที่เลือก: <span id="selectedCount">0</span> คน</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enhanced search function with real-time counter
        function filterVhvOptions() {
            const input = document.getElementById('vhvSearchInput');
            if (!input) return;
            const filter = input.value.trim().toLowerCase();
            const options = document.querySelectorAll('.vhv-option');
            let visibleCount = 0;
            
            options.forEach(option => {
                const name = option.getAttribute('data-fullname') || '';
                const moo = option.getAttribute('data-moo') || '';
                if (name.toLowerCase().includes(filter) || moo.toLowerCase().includes(filter)) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkedBoxes = document.querySelectorAll('input[name="attendees"]:checked');
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = checkedBoxes.length;
            }
        }

        // Add event listeners to checkboxes when modal opens
        function addCheckboxListeners() {
            const checkboxes = document.querySelectorAll('input[name="attendees"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
            updateSelectedCount();
        }

        function collectFormData() {
            const selectedAttendees = Array.from(document.querySelectorAll('input[name="attendees"]:checked')).map(cb => cb.value);
            return {
                date: document.getElementById('meetingDate').value,
                topic: document.getElementById('meetingTopic').value,
                summary: document.getElementById('meetingSummary').value,
                attendees: selectedAttendees,
                facilityId: appState.user.facilityId,
                userId: appState.user.idCard
            };
        }

        // --- Enhanced CRUD Functions ---
        function showAddMeetingModal() {
            Swal.fire({
                title: `<div class="flex items-center gap-3 justify-center"><div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></div><span class="text-2xl font-bold text-gray-800">เพิ่มบันทึกการประชุม</span></div>`,
                html: getMeetingFormHTML(),
                width: '900px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save mr-2"></i>บันทึกข้อมูล',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                customClass: {
                    confirmButton: 'gradient-button text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover-lift',
                    cancelButton: 'bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover-lift'
                },
                buttonsStyling: false,
                didOpen: () => {
                    addCheckboxListeners();
                },
                preConfirm: async () => {
                    const data = collectFormData();
                    if (!data.date || !data.topic.trim()) {
                        Swal.showValidationMessage('กรุณากรอกวันที่และหัวข้อการประชุม');
                        return false;
                    }
                    Swal.showLoading();
                    return await handleApiRequest({ action: 'addMeeting', ...data });
                }
            }).then(result => {
                if (result.isConfirmed && result.value.status === 'success') {
                    Swal.fire({
                        title: 'สำเร็จ!',
                        text: 'เพิ่มข้อมูลการประชุมเรียบร้อย',
                        icon: 'success',
                        confirmButtonText: 'ตกลง',
                        customClass: {
                            confirmButton: 'gradient-button text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                        },
                        buttonsStyling: false
                    });
                    fetchInitialData();
                } else if (result.isConfirmed) {
                    Swal.fire({
                        title: 'ผิดพลาด',
                        text: result.value.message,
                        icon: 'error',
                        confirmButtonText: 'ตกลง',
                        customClass: {
                            confirmButton: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                        },
                        buttonsStyling: false
                    });
                }
            });
        }

        function showEditMeetingModal(meetingId) {
            const meeting = appState.meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            Swal.fire({
                title: `<div class="flex items-center gap-3 justify-center"><div class="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></div><span class="text-2xl font-bold text-gray-800">แก้ไขบันทึกการประชุม</span></div>`,
                html: getMeetingFormHTML(meeting),
                width: '900px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save mr-2"></i>บันทึกการแก้ไข',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                customClass: {
                    confirmButton: 'gradient-button text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover-lift',
                    cancelButton: 'bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover-lift'
                },
                buttonsStyling: false,
                didOpen: () => {
                    addCheckboxListeners();
                },
                preConfirm: async () => {
                    const data = collectFormData();
                    if (!data.date || !data.topic.trim()) {
                        Swal.showValidationMessage('กรุณากรอกวันที่และหัวข้อการประชุม');
                        return false;
                    }
                    Swal.showLoading();
                    return await handleApiRequest({ action: 'updateMeeting', id: meetingId, ...data });
                }
            }).then(result => {
                if (result.isConfirmed && result.value.status === 'success') {
                    Swal.fire({
                        title: 'สำเร็จ!',
                        text: 'แก้ไขข้อมูลเรียบร้อย',
                        icon: 'success',
                        confirmButtonText: 'ตกลง',
                        customClass: {
                            confirmButton: 'gradient-button text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                        },
                        buttonsStyling: false
                    });
                    fetchInitialData();
                } else if (result.isConfirmed) {
                    Swal.fire({
                        title: 'ผิดพลาด',
                        text: result.value.message,
                        icon: 'error',
                        confirmButtonText: 'ตกลง',
                        customClass: {
                            confirmButton: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                        },
                        buttonsStyling: false
                    });
                }
            });
        }
        
        function showViewMeetingModal(meetingId) {
            const meeting = appState.meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            const meetingDate = new Date(meeting.date).toLocaleDateString('th-TH', { dateStyle: 'full' });
            const attendeeList = meeting.attendees && meeting.attendees.length > 0
                ? meeting.attendees.map(a => `
                    <li class="flex items-center gap-3 py-2 px-3 bg-blue-50 rounded-lg">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            ${a.fullName.charAt(0)}
                        </div>
                        <span class="font-medium text-gray-800">${a.fullName}</span>
                    </li>
                `).join('')
                : '<li class="text-center py-8 text-gray-500">ไม่มีผู้เข้าร่วม</li>';

            Swal.fire({
                title: `<div class="flex items-center gap-3 justify-center mb-4"><div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></div><span class="text-2xl font-bold text-gray-800">รายละเอียดการประชุม</span></div>`,
                html: `
                    <div class="text-left max-w-4xl mx-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card rounded-2xl p-6">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">วันที่ประชุม</h3>
                                </div>
                                <p class="text-gray-700 text-lg">${meetingDate}</p>
                            </div>
                            
                            <div class="glass-card rounded-2xl p-6">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">ผู้เข้าร่วม</h3>
                                </div>
                                <p class="text-gray-700 text-2xl font-bold">${meeting.attendees.length} <span class="text-base font-normal">คน</span></p>
                            </div>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">หัวข้อการประชุม</h3>
                            </div>
                            <p class="text-gray-700 text-lg font-medium">${meeting.topic}</p>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">สรุปเนื้อหา</h3>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-gray-700 leading-relaxed">
                                ${meeting.summary ? meeting.summary.replace(/\n/g, '<br>') : 'ไม่มีสรุปเนื้อหา'}
                            </div>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">รายชื่อผู้เข้าร่วม</h3>
                            </div>
                            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto">
                                ${attendeeList}
                            </ul>
                        </div>
                    </div>
                `,
                width: '1000px',
                confirmButtonText: 'ปิด',
                customClass: {
                    confirmButton: 'bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                },
                buttonsStyling: false
            });
        }

        function confirmDeleteMeeting(meetingId) {
            const meeting = appState.meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            Swal.fire({
                title: `<div class="text-center"><div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div><span class="text-2xl font-bold text-gray-800">ยืนยันการลบ?</span></div>`,
                html: `
                    <div class="text-center space-y-4">
                        <div class="glass-card rounded-2xl p-6 mx-auto max-w-md">
                            <p class="text-gray-700 text-lg mb-4">คุณต้องการลบการประชุมเรื่อง</p>
                            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                                <p class="font-semibold text-red-800">"${meeting.topic}"</p>
                                <p class="text-sm text-red-600 mt-1">วันที่ ${new Date(meeting.date).toLocaleDateString('th-TH')}</p>
                            </div>
                            <p class="text-gray-600 mt-4">การดำเนินการนี้ไม่สามารถยกเลิกได้</p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="fas fa-trash mr-2"></i>ใช่, ลบเลย!',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                customClass: {
                    confirmButton: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift',
                    cancelButton: 'bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        html: `
                            <div class="flex flex-col items-center gap-4">
                                <div class="w-16 h-16 border-4 border-red-200 rounded-full animate-spin border-t-red-600"></div>
                                <p class="text-gray-600">กรุณารอสักครู่...</p>
                            </div>
                        `,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: async () => {
                            const response = await handleApiRequest({ action: 'deleteMeeting', id: meetingId });
                            if (response.status === 'success') {
                                Swal.fire({
                                    title: 'ลบสำเร็จ!',
                                    text: 'ข้อมูลการประชุมถูกลบแล้ว',
                                    icon: 'success',
                                    confirmButtonText: 'ตกลง',
                                    customClass: {
                                        confirmButton: 'gradient-button text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                                    },
                                    buttonsStyling: false
                                });
                                fetchInitialData();
                            } else {
                                Swal.fire({
                                    title: 'ผิดพลาด',
                                    text: response.message,
                                    icon: 'error',
                                    confirmButtonText: 'ตกลง',
                                    customClass: {
                                        confirmButton: 'bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover-lift'
                                    },
                                    buttonsStyling: false
                                });
                            }
                        }
                    });
                }
            });
        }
        
        async function handleApiRequest(payload) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                if (!response.ok) throw new Error('Network response was not ok.');
                return await response.json();
            } catch (error) {
                console.error('API Request Error:', error);
                return { status: 'error', message: error.message };
            }
        }
    </script>

</body>
</html>